<!DOCTYPE html>
<html>
<head>
    <title>üèéÔ∏è MARIOKART FastBot Monitor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #001122 0%, #003366 30%, #1a4d6b  60%, #2e5f7a 100%);
            color: #ffffff;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Monaco Harbor Background Effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 150, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
        }
        
        .header {
            background: linear-gradient(135deg, rgba(0, 17, 34, 0.95) 0%, rgba(0, 51, 102, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #FFD700;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .monaco-crown {
            font-size: 2.5em;
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700;
            margin-bottom: 10px;
            animation: royal-glow 3s ease-in-out infinite;
        }
        
        @keyframes royal-glow {
            0%, 100% { text-shadow: 0 0 30px #FFD700, 0 0 40px #FFD700; }
            50% { text-shadow: 0 0 40px #FFD700, 0 0 60px #FFD700, 0 0 80px #FFD700; }
        }
        
        .header h1 {
            margin: 0;
            font-family: 'Orbitron', monospace;
            font-size: 2.2em;
            font-weight: 900;
            letter-spacing: 2px;
            background: linear-gradient(45deg, #FFD700, #FFF, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .monaco-subtitle {
            font-size: 1.2em;
            color: #87CEEB;
            margin-top: 10px;
            letter-spacing: 2px;
            font-weight: 300;
        }
        
        .container {
            max-width: 1850px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .telemetry-card {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.08) 0%, 
                rgba(0, 51, 102, 0.15) 30%, 
                rgba(0, 17, 34, 0.9) 100%);
            backdrop-filter: blur(20px);
            padding: 20px;
            margin: 10px 0;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .telemetry-card:hover {
            border-color: #FFD700;
            box-shadow: 
                0 12px 40px rgba(255, 215, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .telemetry-card h2 {
            margin: 0 0 25px 0;
            font-family: 'Orbitron', monospace;
            color: #FFD700;
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .monaco-divider {
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #FFD700 20%, 
                #87CEEB 50%, 
                #FFD700 80%, 
                transparent 100%);
            margin: 20px 0;
            border-radius: 1px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric {
            background: linear-gradient(135deg, 
                rgba(135, 206, 235, 0.1) 0%, 
                rgba(0, 17, 34, 0.8) 100%);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(135, 206, 235, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            animation: monaco-shine 3s infinite;
        }
        
        @keyframes monaco-shine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        
        .metric:hover {
            border-color: #87CEEB;
            transform: scale(1.02);
        }
        
        .metric-label {
            font-size: 12px;
            color: #87CEEB;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-family: 'Orbitron', monospace;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .speed-display {
            font-size: 3em !important;
            color: #FFD700 !important;
            text-shadow: 0 0 30px #FFD700 !important;
            animation: speed-pulse 2s ease-in-out infinite;
        }
        
        .lap-time-display {
            font-size: 3em !important;
            color: #00D2BE !important;
            text-shadow: 0 0 30px #00D2BE !important;
            animation: lap-time-glow 3s ease-in-out infinite;
        }
        
        @keyframes speed-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes lap-time-glow {
            0%, 100% { 
                color: #00D2BE;
                text-shadow: 0 0 30px #00D2BE;
            }
            50% { 
                color: #87CEEB;
                text-shadow: 0 0 40px #87CEEB, 0 0 60px #00D2BE;
            }
        }
        
        @keyframes lap-finish-flash {
            0%, 100% { 
                transform: scale(1);
                color: #FFD700;
                text-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700;
                background: linear-gradient(45deg, rgba(255, 215, 0, 0.3), rgba(255, 255, 255, 0.2));
            }
            25%, 75% { 
                transform: scale(1.5);
                color: #FF4444;
                text-shadow: 0 0 60px #FF4444, 0 0 120px #FFD700;
                background: linear-gradient(45deg, rgba(255, 68, 68, 0.4), rgba(255, 215, 0, 0.3));
            }
            50% { 
                transform: scale(1.8);
                color: #FFFFFF;
                text-shadow: 0 0 80px #FFFFFF, 0 0 150px #FFD700, 0 0 200px #FF4444;
                background: linear-gradient(45deg, rgba(255, 255, 255, 0.5), rgba(255, 215, 0, 0.4));
            }
        }
        
        .lap-finish-animation {
            animation: lap-finish-flash 2s ease-in-out 3;
            border-radius: 15px;
            padding: 20px;
            border: 3px solid #FFD700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            z-index: 1000;
            position: relative;
        }
        
        #video-feed {
            border: 3px solid #FFD700;
            border-radius: 15px;
            box-shadow: 
                0 0 50px rgba(255, 215, 0, 0.4),
                inset 0 0 20px rgba(0, 0, 0, 0.3);
            background: #000;
            image-rendering: pixelated;
        }
        
        .video-container {
            text-align: center;
            position: relative;
        }
        
        .video-stats {
            margin-top: 15px;
            color: #87CEEB;
            font-family: 'Orbitron', monospace;
            font-size: 1.1em;
            letter-spacing: 1px;
        }
        
        .commentary-section {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                rgba(135, 206, 235, 0.1) 50%, 
                rgba(0, 17, 34, 0.9) 100%);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(135, 206, 235, 0.4);
            text-align: center;
            font-style: italic;
            font-size: 1.3em;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            line-height: 1.4;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .commentary-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #FFD700, #87CEEB, #FFD700);
            animation: commentary-glow 4s ease-in-out infinite;
        }
        
        @keyframes commentary-glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .monaco-flag {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1.5em;
            opacity: 0.7;
        }
        
        /* Yacht and Casino atmosphere */
        .luxury-accent {
            color: #FFD700;
            text-shadow: 0 0 10px #FFD700;
        }
        
        .harbor-blue {
            color: #87CEEB;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="monaco-crown">üëë</div>
        <h1>MARIOKART</h1>
        <div class="monaco-subtitle">FASTBOT RACING MONITOR</div>
        <div class="monaco-flag">üèÅ</div>
    </div>
    
    <div class="container">

        <div class="telemetry-card">
            <h2>üì∫ Live Circuit View</h2>
            <div class="monaco-divider"></div>
            <div style="display: flex; justify-content: center;">
                <!-- Track Map with Video Feed Inside -->
                <div style="margin-left: 40px;">
                    <div style="font-size: 12px; color: #00D2BE; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; margin-bottom: 10px; text-align: center;">Track Map & Live View</div>
                    <div style="position: relative; width: 600px; height: 500px; background: rgba(0, 17, 34, 0.8); border: 2px solid rgba(0, 210, 190, 0.3); border-radius: 10px;">
                        <canvas id="track-canvas" width="596" height="496" style="border-radius: 8px; background: rgba(0, 0, 0, 0.3);"></canvas>
                        
                        <!-- Video Feed - moves with car position -->
                        <div id="video-container-moving" class="video-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; transition: all 0.3s ease;">
                            <img id="video-feed" style="max-width: 80px; max-height: 60px; border: 2px solid #FFFFFF; border-radius: 4px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);">
                        </div>
                        
                        
                        <!-- Lap Time Display - Circular Design -->
                        <div id="track-lap-time" class="metric" style="position: absolute; top: 10px; right: 30px; z-index: 15;">
                            <!-- Outer black circular dial -->
                            <div style="position: relative; width: 120px; height: 120px; background: linear-gradient(135deg, #404040 0%, #606060 50%, #404040 100%); border-radius: 50%; border: 3px solid #FFD700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.4); display: flex; align-items: center; justify-content: center;">
                                
                                <!-- Inner white circular dial -->
                                <div style="position: relative; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 248, 0.95) 70%, rgba(235, 235, 235, 0.9) 100%); border-radius: 50%; border: 2px solid rgba(255, 215, 0, 0.5); box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);">
                                    
                                    <!-- Lap Time label at top -->
                                    <div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <div style="font-size: 8px; color: #666666; font-family: 'Orbitron', monospace; font-weight: 600; letter-spacing: 1px;">LAP TIME</div>
                                    </div>
                                    
                                    <!-- Lap Time value in center -->
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div id="track-lap-time-value" style="font-size: 20px; font-weight: 900; color: #1a1a1a; font-family: 'Orbitron', monospace; text-shadow: 0 0 3px rgba(0, 0, 0, 0.3); animation: speed-pulse 2s ease-in-out infinite;">0.0s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Speedometer - Matching Lap Time Style -->
                        <div id="ferrari-speedometer" class="metric" style="position: absolute; top: 180px; right: 30px; z-index: 15;">
                            <!-- Outer black circular dial -->
                            <div style="position: relative; width: 120px; height: 120px; background: linear-gradient(135deg, #404040 0%, #606060 50%, #404040 100%); border-radius: 50%; border: 3px solid #FFD700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.4); display: flex; align-items: center; justify-content: center;">
                                
                                <!-- Inner white circular dial -->
                                <div style="position: relative; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255, 255, 255, 0.98) 0%, rgba(248, 248, 248, 0.95) 70%, rgba(235, 235, 235, 0.9) 100%); border-radius: 50%; border: 2px solid rgba(255, 215, 0, 0.5); box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);">
                                    
                                    <!-- Semi-circular speed dial (top half) -->
                                    <div id="speedometer-dial" style="position: absolute; top: 0; left: 0; width: 100px; height: 50px; background: radial-gradient(circle at 50% 100%, rgba(255, 69, 0, 0.9) 0%, rgba(255, 140, 0, 0.8) 40%, rgba(255, 215, 0, 0.3) 100%); border-radius: 50px 50px 0 0; border: 2px solid rgba(255, 215, 0, 0.5); border-bottom: none; box-shadow: 0 0 15px rgba(255, 69, 0, 0.4), inset 0 0 10px rgba(255, 69, 0, 0.6); transition: all 0.5s ease; overflow: hidden;">
                                        
                                        <!-- Speed scale marks for semi-circle -->
                                        <div style="position: absolute; top: 5px; left: 50%; width: 1px; height: 8px; background: #1a1a1a; transform: translateX(-50%);"></div>
                                        <div style="position: absolute; top: 8px; right: 12px; width: 1px; height: 6px; background: #1a1a1a; transform: rotate(45deg);"></div>
                                        <div style="position: absolute; bottom: 0; right: 5px; width: 6px; height: 1px; background: #1a1a1a; transform: translateY(-50%);"></div>
                                        <div style="position: absolute; bottom: 0; left: 5px; width: 6px; height: 1px; background: #1a1a1a; transform: translateY(-50%);"></div>
                                        <div style="position: absolute; top: 8px; left: 12px; width: 1px; height: 6px; background: #1a1a1a; transform: rotate(-45deg);"></div>
                                    </div>
                                    
                                    <!-- Speed needle with attached golden center -->
                                    <div id="speed-needle" style="position: absolute; top: 50%; left: 50%; width: 2px; height: 40px; background: linear-gradient(to top, #FF4500 0%, #1a1a1a 100%); transform-origin: bottom center; transform: translate(-50%, -50%) rotate(-90deg); border-radius: 1px; box-shadow: 0 0 8px rgba(255, 69, 0, 0.6); transition: transform 0.3s ease; z-index: 10;">
                                        <!-- Golden hub attached to needle -->
                                        <div style="position: absolute; bottom: -5px; left: 50%; width: 10px; height: 10px; background: radial-gradient(circle, #FFD700 0%, #1a1a1a 100%); border-radius: 50%; transform: translateX(-50%); border: 1px solid #FFFFFF; box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);"></div>
                                    </div>
                                    
                                    <!-- Speed value moved higher -->
                                    <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <div id="ferrari-speed-value" style="font-size: 16px; font-weight: 900; color: #1a1a1a; font-family: 'Orbitron', monospace; text-shadow: 0 0 3px rgba(0, 0, 0, 0.3); animation: speed-pulse 2s ease-in-out infinite;">0.0</div>
                                    </div>
                                    
                                    <!-- m/s unit in the white area -->
                                    <div style="position: absolute; top: 55px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <div style="font-size: 7px; color: #333333; font-family: 'Orbitron', monospace; font-weight: 600; letter-spacing: 0.8px; text-shadow: 0 0 1px rgba(0, 0, 0, 0.2);">m/s</div>
                                    </div>
                                    
                                    <!-- SPEED label moved lower -->
                                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center;">
                                        <div style="font-size: 8px; color: #666666; font-family: 'Orbitron', monospace; font-weight: 600; letter-spacing: 1px;">SPEED</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LIDAR overlays on track map -->
                        <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 210, 190, 0.15); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0, 210, 190, 0.3);">
                            <div style="font-size: 8px; color: #00D2BE;">F</div>
                            <div style="font-size: 10px; font-weight: 700; color: #ffffff;" id="front-distance">‚àû</div>
                        </div>
                        <div style="position: absolute; left: -35px; top: 50%; transform: translateY(-50%); background: rgba(0, 210, 190, 0.15); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0, 210, 190, 0.3);">
                            <div style="font-size: 8px; color: #00D2BE;">L</div>
                            <div style="font-size: 10px; font-weight: 700; color: #ffffff;" id="left-distance">‚àû</div>
                        </div>
                        <div style="position: absolute; right: -35px; top: 50%; transform: translateY(-50%); background: rgba(0, 210, 190, 0.15); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0, 210, 190, 0.3);">
                            <div style="font-size: 8px; color: #00D2BE;">R</div>
                            <div style="font-size: 10px; font-weight: 700; color: #ffffff;" id="right-distance">‚àû</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="telemetry-card">
            <h2>üéôÔ∏è MARIOKART Circuit Commentary</h2>
            <div class="monaco-divider"></div>
            <div class="commentary-section">
                <span id="live-commentary">Welcome to the exciting MARIOKART Circuit... Awaiting race data...</span>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        let app = null;
        let database = null;
        let frameCount = 0;

        // Commentary lookup table for efficient telemetry
        const COMMENTARY_LOOKUP = {
            'casino_straight': [
                "FLYING through the start! üèÅ",
                "PEDAL TO THE METAL down Casino!",
                "MAXIMUM ATTACK MODE!",
                "Building INCREDIBLE speed!",
                "LAUNCHING like a rocket!",
                "The crowd goes WILD!",
                "THUNDER down the straight!",
                "Absolutely SENDING it!",
                "FLAT OUT through Casino!",
                "Engine at FULL SONG!",
                "BLISTERING pace here!",
                "What a START from Dad Fitt!"
            ],
            'beau_rivage': [
                "POWERING up Beau Rivage!",
                "The LEGENDARY climb begins!",
                "Defying GRAVITY here!",
                "ATTACKING the hill!",
                "Engine SCREAMING uphill!",
                "What a MAGNIFICENT ascent!",
                "CONQUERING the rise!",
                "Momentum is EVERYTHING here!",
                "PUSHING hard up the slope!",
                "The car SURGES forward!",
                "BRILLIANT climb technique!",
                "Dad Fitt makes it look EASY!"
            ],
            'massenet_complex': [
                "THREADING the needle!",
                "Surgical PRECISION required!",
                "DANCING through Massenet!",
                "This is POETRY in motion!",
                "INCREDIBLE car control!",
                "Making it look EASY!",
                "INCH-PERFECT through here!",
                "Technical MASTERCLASS!",
                "WEAVING through barriers!",
                "Dad Fitt showing his CLASS!",
                "RAZOR-SHARP reflexes!",
                "What a DEMONSTRATION!"
            ],
            'mirabeau_descent': [
                "PLUNGING down Mirabeau!",
                "GRAVITY-DEFYING descent!",
                "The DROP is INSANE!",
                "COMMITMENT through here!",
                "Brake temps CRITICAL!",
                "FEARLESS through the descent!",
                "BREATHTAKING bravery!",
                "Downhill CHARGE!",
                "The car DIVES down!",
                "SPECTACULAR descent!",
                "Dad Fitt is ON IT!",
                "MAGNIFICENT control!"
            ],
            'portier_approach': [
                "SETTING UP for glory!",
                "The tunnel BECKONS!",
                "PRECISION before darkness!",
                "Heart rate SPIKING!",
                "PERFECT positioning!",
                "The calm before the STORM!",
                "CRUCIAL setup phase!",
                "Entry speed is KEY!",
                "NAILING the approach!",
                "Tunnel run INCOMING!",
                "Dad Fitt PREPARES!",
                "FLAWLESS line here!"
            ],
            'monaco_tunnel_entry': [
                "HERE COMES THE TUNNEL!",
                "Into the ABYSS!",
                "LIGHTS OUT ahead!",
                "BRACE for darkness!",
                "The FAMOUS tunnel awaits!",
                "COMMITTED to the entry!",
                "DARKNESS approaches FAST!",
                "TUNNEL vision mode!",
                "The ICONIC passage!",
                "Dad Fitt DISAPPEARS!",
                "Into the VOID!",
                "SENSATIONAL entry speed!"
            ],
            'grand_tunnel': [
                "THUNDERING through darkness!",
                "ECHO CHAMBER of speed!",
                "FLAT OUT in the tunnel!",
                "The sound is DEAFENING!",
                "PURE SPEED in darkness!",
                "EMERGING like a MISSILE!",
                "SONIC BOOM underground!",
                "MAXIMUM velocity here!",
                "The tunnel ROARS!",
                "Dad Fitt is FLYING!",
                "UNBELIEVABLE speed!",
                "Light at the END!"
            ],
            'nouvelle_chicane': [
                "BLINDED by daylight!",
                "LIGHTNING reflexes!",
                "SNAP direction change!",
                "From darkness to CHAOS!",
                "NAILING the chicane!",
                "What a TRANSITION!",
                "INSTANT adaptation!",
                "Left-right PERFECTION!",
                "Dad Fitt ATTACKS!",
                "PHENOMENAL agility!",
                "The chicane BITES!",
                "TEXTBOOK execution!"
            ],
            'piscine_complex': [
                "DIVING into the pool!",
                "TECHNICAL MASTERCLASS!",
                "PRECISION at the limit!",
                "Swimming pool BALLET!",
                "INCH-PERFECT through here!",
                "The crowd is ON THEIR FEET!",
                "SUPREME concentration!",
                "Dad Fitt is SURGICAL!",
                "MILLIMETER margins!",
                "BREATHTAKING skill!",
                "The SHOWCASE section!",
                "ABSOLUTELY clinical!"
            ],
            'rascasse_finale': [
                "FINAL PUSH TO GLORY!",
                "The finish line CALLS!",
                "MAXIMUM ATTACK to the line!",
                "GIVE IT EVERYTHING!",
                "The LEGENDARY Rascasse!",
                "HISTORY in the making!",
                "Dad Fitt UNLEASHED!",
                "SENSATIONAL finale!",
                "The crowd goes WILD!",
                "EPIC conclusion!",
                "What a LAP!",
                "CROSSING THE LINE!"
            ]
        };
        
        function getCommentary(section, index) {
            if (!section || !COMMENTARY_LOOKUP[section] || index < 0) {
                return "Racing through the circuit!";
            }
            const comments = COMMENTARY_LOOKUP[section];
            return index < comments.length ? comments[index] : comments[0];
        }

        function connectToFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyDRaKw_Yj8J_tvMR75Ejlkz5ASpyLQJotg",
                authDomain: "summer-race-monitoring.firebaseapp.com",
                databaseURL: "https://summer-race-monitoring-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "summer-race-monitoring"
            };

            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                
                const telemetryRef = ref(database, 'robots/race_monitor/telemetry');
                const videoRef = ref(database, 'robots/race_monitor/video_frame');

                onValue(telemetryRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) updateTelemetry(data);
                });

                onValue(videoRef, (snapshot) => {
                    const frameData = snapshot.val();
                    if (frameData && frameData.image) {
                        document.getElementById('video-feed').src = 'data:image/jpeg;base64,' + frameData.image;
                        frameCount++;
                        
                        // Calculate delay
                        const now = Date.now();
                        const frameTime = frameData.timestamp * 1000;
                        const delay = now - frameTime;
                        document.getElementById('video-delay').textContent = Math.round(delay);
                    }
                });

            } catch (error) {
                console.error('Firebase connection error:', error);
            }
        }

        // Track visualization variables
        let trackWaypoints = [];
        let trackLoaded = false;
        let trackBounds = { minX: 0, maxX: 0, minY: 0, maxY: 0 };
        
        // Lap completion detection
        let previousLapProgress = -1; // Start with -1 to indicate uninitialized
        let lapFlashTimeout = null;
        let lapCompleted = false;
        let raceStarted = false;
        
        // Load actual track data from the master race track
        function loadTrackData() {
            // Actual track coordinates from master_race_track_complete.pkl
            const actualTrackCoords = [
                [9.161, 0.008], [9.162, 0.052], [9.160, 0.108], [9.149, 0.212], [9.130, 0.319], 
                [9.101, 0.457], [9.054, 0.615], [9.011, 0.780], [8.951, 0.980], [8.902, 1.140], 
                [8.852, 1.303], [8.809, 1.471], [8.775, 1.682], [8.754, 1.848], [8.741, 2.016], 
                [8.726, 2.228], [8.718, 2.397], [8.697, 2.602], [8.677, 2.827], [8.651, 3.108], 
                [8.629, 3.333], [8.612, 3.560], [8.604, 3.842], [8.604, 4.068], [8.605, 4.294], 
                [8.604, 4.519], [8.594, 4.800], [8.581, 5.018], [8.580, 5.244], [8.578, 5.525], 
                [8.570, 5.750], [8.563, 5.975], [8.561, 6.200], [8.565, 6.484], [8.580, 6.709], 
                [8.595, 6.934], [8.605, 7.215], [8.602, 7.440], [8.593, 7.665], [8.589, 7.892], 
                [8.584, 8.173], [8.573, 8.399], [8.562, 8.624], [8.546, 8.907], [8.537, 9.132], 
                [8.527, 9.358], [8.527, 9.584], [8.532, 9.866], [8.531, 10.091], [8.515, 10.316], 
                [8.493, 10.598], [8.471, 10.823], [8.451, 11.048], [8.431, 11.273], [8.406, 11.555], 
                [8.386, 11.779], [8.363, 12.004], [8.330, 12.343], [8.300, 12.623], [8.272, 12.902], 
                [8.237, 13.180], [8.196, 13.529], [8.162, 13.808], [8.127, 14.087], [8.072, 14.435], 
                [8.029, 14.713], [7.988, 14.992], [7.935, 15.268], [7.846, 15.610], [7.766, 15.880], 
                [7.691, 16.153], [7.593, 16.491], [7.508, 16.759], [7.401, 17.019], [7.281, 17.278], 
                [7.112, 17.588], [6.961, 17.823], [6.803, 18.056], [6.598, 18.340], [6.430, 18.567], 
                [6.265, 18.795], [6.104, 19.023], [5.889, 19.302], [5.707, 19.514], [5.514, 19.718], 
                [5.254, 19.952], [5.035, 20.126], [4.804, 20.290], [4.569, 20.443], [4.269, 20.635], 
                [4.034, 20.785], [3.787, 20.920], [3.469, 21.070], [3.207, 21.173], [2.944, 21.268], 
                [2.690, 21.359], [2.362, 21.479], [2.096, 21.572], [1.833, 21.662], [1.494, 21.747], 
                [1.219, 21.801], [0.941, 21.833], [0.592, 21.829], [0.312, 21.802], [0.034, 21.757], 
                [-0.242, 21.700], [-0.585, 21.614], [-0.860, 21.555], [-1.137, 21.504], [-1.414, 21.453], 
                [-1.754, 21.368], [-2.021, 21.282], [-2.277, 21.165], [-2.579, 20.984], [-2.809, 20.823], 
                [-3.033, 20.652], [-3.247, 20.469], [-3.507, 20.231], [-3.716, 20.043], [-3.924, 19.853], 
                [-4.167, 19.597], [-4.353, 19.387], [-4.537, 19.167], [-4.710, 18.940], [-4.907, 18.648], 
                [-5.055, 18.405], [-5.191, 18.157], [-5.338, 17.837], [-5.446, 17.576], [-5.542, 17.311], 
                [-5.626, 17.042], [-5.717, 16.702], [-5.773, 16.426], [-5.818, 16.147], [-5.851, 15.797], 
                [-5.863, 15.515], [-5.859, 15.234], [-5.838, 14.954], [-5.803, 14.603], [-5.773, 14.321], 
                [-5.740, 14.042], [-5.675, 13.696], [-5.607, 13.423], [-5.527, 13.153], [-5.432, 12.887], 
                [-5.297, 12.560], [-5.173, 12.307], [-5.048, 12.055], [-4.886, 11.744], [-4.747, 11.501], 
                [-4.598, 11.261], [-4.447, 11.023], [-4.259, 10.725], [-4.106, 10.489], [-3.940, 10.261], 
                [-3.720, 9.988], [-3.534, 9.775], [-3.350, 9.562], [-3.167, 9.348], [-2.938, 9.082], 
                [-2.745, 8.877], [-2.543, 8.684], [-2.279, 8.451], [-2.062, 8.273], [-1.838, 8.105], 
                [-1.612, 7.935], [-1.334, 7.721], [-1.110, 7.548], [-0.890, 7.375], [-0.617, 7.150], 
                [-0.402, 6.970], [-0.187, 6.788], [0.026, 6.604], [0.290, 6.372], [0.503, 6.188], 
                [0.713, 6.004], [0.963, 5.762], [1.144, 5.550], [1.302, 5.321], [1.430, 5.076], 
                [1.556, 4.752], [1.633, 4.483], [1.698, 4.211], [1.767, 3.868], [1.822, 3.593], 
                [1.877, 3.319], [1.932, 3.044], [1.988, 2.698], [2.017, 2.419], [2.034, 2.138], 
                [2.036, 1.788], [2.028, 1.506], [2.024, 1.225], [2.023, 0.943], [2.031, 0.593], 
                [2.023, 0.312], [2.003, 0.031], [1.961, -0.318], [1.909, -0.595], [1.855, -0.872], 
                [1.798, -1.148], [1.732, -1.494], [1.669, -1.770], [1.575, -2.110], [1.480, -2.377], 
                [1.359, -2.634], [1.213, -2.875], [1.043, -3.102], [0.798, -3.360], [0.585, -3.551], 
                [0.354, -3.712], [0.046, -3.882], [-0.215, -3.991], [-0.486, -4.075], [-0.763, -4.130], 
                [-1.119, -4.151], [-1.405, -4.124], [-1.684, -4.053], [-2.005, -3.908], [-2.240, -3.749], 
                [-2.457, -3.565], [-2.701, -3.309], [-2.877, -3.088], [-3.047, -2.861], [-3.219, -2.638], 
                [-3.439, -2.362], [-3.607, -2.135], [-3.772, -1.906], [-3.940, -1.679], [-4.153, -1.400], 
                [-4.312, -1.167], [-4.500, -0.868], [-4.639, -0.624], [-4.777, -0.377], [-4.917, -0.133], 
                [-5.056, 0.112], [-5.235, 0.413], [-5.376, 0.655], [-5.522, 0.894], [-5.709, 1.185], 
                [-5.865, 1.420], [-6.054, 1.716], [-6.175, 1.888], [-6.389, 2.165], [-6.576, 2.375], 
                [-6.828, 2.620], [-7.041, 2.803], [-7.259, 2.982], [-7.477, 3.159], [-7.697, 3.336], 
                [-7.978, 3.543], [-8.215, 3.688], [-8.463, 3.816], [-8.791, 3.937], [-9.059, 4.017], 
                [-9.329, 4.080], [-9.604, 4.129], [-9.951, 4.172], [-10.233, 4.195], [-10.514, 4.200], 
                [-10.866, 4.184], [-11.146, 4.153], [-11.423, 4.105], [-11.698, 4.043], [-12.034, 3.943], 
                [-12.297, 3.845], [-12.556, 3.735], [-12.870, 3.576], [-13.115, 3.435], [-13.349, 3.282], 
                [-13.574, 3.115], [-13.843, 2.892], [-14.046, 2.702], [-14.294, 2.452], [-14.470, 2.238], 
                [-14.629, 2.009], [-14.768, 1.768], [-14.881, 1.514], [-14.998, 1.185], [-15.064, 0.914], 
                [-15.109, 0.636], [-15.129, 0.291], [-15.118, 0.013], [-15.080, -0.261], [-15.035, -0.538], 
                [-14.963, -0.880], [-14.893, -1.151], [-14.817, -1.420], [-14.698, -1.750], [-14.592, -2.011], 
                [-14.445, -2.332], [-14.356, -2.524], [-14.211, -2.848], [-14.099, -3.107], [-13.980, -3.364], 
                [-13.816, -3.675], [-13.679, -3.921], [-13.543, -4.168], [-13.406, -4.413], [-13.234, -4.722], 
                [-13.097, -4.967], [-12.967, -5.217], [-12.797, -5.525], [-12.653, -5.766], [-12.499, -6.001], 
                [-12.343, -6.233], [-12.147, -6.524], [-11.988, -6.753], [-11.827, -6.983], [-11.645, -7.278], 
                [-11.509, -7.522], [-11.377, -7.769], [-11.246, -8.016], [-11.082, -8.322], [-10.940, -8.559], 
                [-10.785, -8.786], [-10.584, -9.070], [-10.424, -9.299], [-10.265, -9.528], [-10.117, -9.761], 
                [-9.942, -10.059], [-9.801, -10.298], [-9.663, -10.537], [-9.493, -10.834], [-9.352, -11.063], 
                [-9.212, -11.299], [-9.068, -11.535], [-8.887, -11.829], [-8.743, -12.067], [-8.597, -12.302], 
                [-8.416, -12.600], [-8.271, -12.839], [-8.123, -13.079], [-7.975, -13.320], [-7.790, -13.620], 
                [-7.640, -13.861], [-7.444, -14.155], [-7.276, -14.383], [-7.107, -14.609], [-6.946, -14.840], 
                [-6.783, -15.071], [-6.580, -15.359], [-6.414, -15.587], [-6.259, -15.821], [-6.083, -16.123], 
                [-5.952, -16.372], [-5.820, -16.620], [-5.692, -16.868], [-5.520, -17.170], [-5.375, -17.405], 
                [-5.230, -17.637], [-5.053, -17.926], [-4.915, -18.158], [-4.780, -18.388], [-4.646, -18.619], 
                [-4.482, -18.910], [-4.354, -19.139], [-4.228, -19.371], [-4.071, -19.660], [-3.943, -19.891], 
                [-3.809, -20.123], [-3.675, -20.353], [-3.500, -20.642], [-3.359, -20.870], [-3.214, -21.100], 
                [-3.029, -21.386], [-2.880, -21.614], [-2.726, -21.841], [-2.566, -22.065], [-2.348, -22.335], 
                [-2.181, -22.556], [-2.011, -22.778], [-1.808, -23.063], [-1.648, -23.294], [-1.489, -23.524], 
                [-1.316, -23.745], [-1.087, -24.013], [-0.902, -24.225], [-0.704, -24.429], [-0.466, -24.692], 
                [-0.287, -24.910], [-0.112, -25.130], [0.066, -25.350], [0.298, -25.617], [0.497, -25.816], 
                [0.707, -26.005], [0.973, -26.235], [1.191, -26.416], [1.456, -26.647], [1.620, -26.781], 
                [1.899, -26.994], [2.132, -27.153], [2.370, -27.302], [2.676, -27.474], [2.928, -27.593], 
                [3.187, -27.685], [3.457, -27.757], [3.800, -27.810], [4.078, -27.825], [4.358, -27.826], 
                [4.707, -27.811], [4.979, -27.778], [5.244, -27.720], [5.510, -27.645], [5.825, -27.510], 
                [6.070, -27.386], [6.307, -27.252], [6.611, -27.094], [6.859, -26.977], [7.097, -26.858], 
                [7.337, -26.734], [7.632, -26.565], [7.865, -26.422], [8.091, -26.272], [8.369, -26.075], 
                [8.593, -25.923], [8.812, -25.766], [9.032, -25.605], [9.305, -25.404], [9.527, -25.246], 
                [9.752, -25.099], [10.048, -24.927], [10.280, -24.799], [10.571, -24.650], [10.749, -24.564], 
                [11.029, -24.436], [11.268, -24.346], [11.553, -24.246], [11.787, -24.187], [12.028, -24.143], 
                [12.266, -24.112], [12.520, -24.109], [12.829, -24.141], [13.077, -24.197], [13.315, -24.286], 
                [13.597, -24.426], [13.811, -24.572], [14.005, -24.728], [14.189, -24.916], [14.400, -25.173], 
                [14.555, -25.400], [14.704, -25.629], [14.919, -25.901], [15.120, -26.096], [15.383, -26.326], 
                [15.540, -26.468], [15.790, -26.713], [15.984, -26.918], [16.175, -27.124], [16.412, -27.384], 
                [16.595, -27.600], [16.762, -27.828], [16.928, -28.057], [17.142, -28.336], [17.337, -28.542], 
                [17.540, -28.737], [17.806, -28.970], [18.019, -29.156], [18.231, -29.343], [18.443, -29.532], 
                [18.710, -29.763], [18.925, -29.946], [19.142, -30.127], [19.422, -30.343], [19.657, -30.501], 
                [19.900, -30.644], [20.148, -30.779], [20.461, -30.941], [20.719, -31.054], [20.985, -31.150], 
                [21.318, -31.264], [21.583, -31.355], [21.854, -31.433], [22.129, -31.496], [22.473, -31.569], 
                [22.751, -31.622], [23.030, -31.660], [23.379, -31.698], [23.661, -31.720], [23.941, -31.743], 
                [24.292, -31.749], [24.575, -31.735], [24.855, -31.718], [25.137, -31.709], [25.491, -31.707], 
                [25.772, -31.703], [26.054, -31.689], [26.333, -31.659], [26.683, -31.618], [26.963, -31.583], 
                [27.241, -31.547], [27.593, -31.505], [27.873, -31.474], [28.153, -31.439], [28.432, -31.406], 
                [28.782, -31.365], [29.063, -31.331], [29.340, -31.286], [29.684, -31.211], [29.956, -31.139], 
                [30.231, -31.069], [30.503, -30.995], [30.845, -30.905], [31.118, -30.830], [31.390, -30.757], 
                [31.724, -30.651], [31.988, -30.551], [32.247, -30.442], [32.507, -30.329], [32.829, -30.189], 
                [33.085, -30.070], [33.331, -29.935], [33.629, -29.748], [33.858, -29.584], [34.080, -29.412], 
                [34.295, -29.230], [34.549, -28.985], [34.736, -28.775], [34.910, -28.553], [35.109, -28.261], 
                [35.255, -28.020], [35.399, -27.778], [35.540, -27.533], [35.708, -27.222], [35.827, -26.967], 
                [35.929, -26.703], [36.047, -26.371], [36.135, -26.102], [36.206, -25.829], [36.264, -25.483], 
                [36.284, -25.203], [36.288, -24.922], [36.283, -24.639], [36.264, -24.287], [36.248, -24.006], 
                [36.227, -23.724], [36.186, -23.445], [36.112, -23.101], [36.035, -22.830], [35.946, -22.563], 
                [35.810, -22.240], [35.674, -21.992], [35.518, -21.758], [35.352, -21.531], [35.124, -21.263], 
                [34.927, -21.061], [34.717, -20.874], [34.439, -20.661], [34.203, -20.506], [33.897, -20.335], 
                [33.704, -20.242], [33.368, -20.130], [33.093, -20.071], [32.814, -20.046], [32.464, -20.060], 
                [32.187, -20.107], [31.918, -20.185], [31.660, -20.296], [31.361, -20.478], [31.135, -20.646], 
                [30.858, -20.865], [30.634, -21.037], [30.403, -21.199], [30.170, -21.359], [29.937, -21.520], 
                [29.647, -21.722], [29.421, -21.891], [29.196, -22.060], [28.917, -22.275], [28.697, -22.451], 
                [28.425, -22.673], [28.260, -22.807], [27.978, -23.015], [27.741, -23.170], [27.498, -23.312], 
                [27.191, -23.480], [26.938, -23.609], [26.679, -23.724], [26.414, -23.829], [26.078, -23.941], 
                [25.804, -24.014], [25.526, -24.069], [25.175, -24.101], [24.891, -24.098], [24.608, -24.065], 
                [24.330, -24.004], [23.999, -23.885], [23.750, -23.761], [23.514, -23.609], [23.245, -23.384], 
                [23.050, -23.180], [22.865, -22.967], [22.690, -22.745], [22.483, -22.459], [22.315, -22.233], 
                [22.151, -22.003], [21.959, -21.707], [21.820, -21.460], [21.706, -21.203], [21.612, -20.937], 
                [21.529, -20.595], [21.487, -20.318], [21.456, -20.039], [21.413, -19.690], [21.371, -19.411], 
                [21.329, -19.133], [21.284, -18.854], [21.253, -18.504], [21.237, -18.222], [21.229, -17.940], 
                [21.218, -17.588], [21.202, -17.308], [21.170, -17.029], [21.125, -16.751], [21.046, -16.410], 
                [20.967, -16.140], [20.884, -15.870], [20.758, -15.542], [20.648, -15.283], [20.522, -15.032], 
                [20.387, -14.783], [20.203, -14.483], [20.046, -14.250], [19.879, -14.023], [19.656, -13.751], 
                [19.462, -13.551], [19.251, -13.367], [19.025, -13.203], [18.723, -13.027], [18.465, -12.904], 
                [18.201, -12.810], [17.859, -12.718], [17.584, -12.661], [17.307, -12.610], [17.030, -12.563], 
                [16.682, -12.507], [16.403, -12.472], [16.125, -12.428], [15.779, -12.374], [15.499, -12.337], 
                [15.219, -12.295], [14.869, -12.252], [14.588, -12.233], [14.307, -12.212], [14.026, -12.191], 
                [13.674, -12.166], [13.394, -12.148], [13.113, -12.128], [12.835, -12.097], [12.486, -12.041], 
                [12.211, -11.984], [11.936, -11.913], [11.600, -11.809], [11.335, -11.707], [11.083, -11.577], 
                [10.852, -11.419], [10.571, -11.208], [10.354, -11.029], [10.144, -10.840], [9.895, -10.592], 
                [9.710, -10.380], [9.549, -10.151], [9.405, -9.908], [9.258, -9.589], [9.169, -9.323], 
                [9.091, -9.052], [9.027, -8.777], [8.947, -8.434], [8.864, -8.091], [8.819, -7.885], 
                [8.757, -7.537], [8.718, -7.258], [8.681, -6.978], [8.627, -6.628], [8.589, -6.347], 
                [8.572, -6.065], [8.551, -5.790], [8.536, -5.438], [8.525, -5.155], [8.515, -4.867], 
                [8.501, -4.445], [8.496, -4.106], [8.494, -3.769], [8.493, -3.431], [8.498, -3.008], 
                [8.490, -2.671], [8.470, -2.334], [8.438, -1.913], [8.421, -1.575], [8.399, -1.151], 
                [8.378, -0.815], [8.346, -0.480], [8.320, -0.139], [8.298, 0.198], [8.277, 0.622], 
                [8.278, 0.949], [8.302, 1.285], [8.322, 1.625], [8.353, 2.046], [8.367, 2.385], 
                [8.363, 2.724], [8.347, 3.148], [8.336, 3.486], [8.336, 3.910], [8.349, 4.164], 
                [8.370, 4.588], [8.386, 4.927], [8.384, 5.267], [8.351, 5.690], [8.317, 6.027], 
                [8.317, 6.086], [8.324, 6.087], [8.332, 6.088], [8.335, 6.087], [8.337, 6.087], 
                [8.340, 6.087], [8.342, 6.087]
            ];
            
            // Convert to trackWaypoints format
            trackWaypoints = actualTrackCoords.map(coord => ({
                x: coord[0],
                y: coord[1]
            }));
            
            // Calculate bounds for accurate scaling
            trackBounds.minX = Math.min(...trackWaypoints.map(p => p.x));
            trackBounds.maxX = Math.max(...trackWaypoints.map(p => p.x));
            trackBounds.minY = Math.min(...trackWaypoints.map(p => p.y));
            trackBounds.maxY = Math.max(...trackWaypoints.map(p => p.y));
            
            trackLoaded = true;
            drawTrack();
        }
        
        function drawTrack() {
            if (!trackLoaded) return;
            
            const canvas = document.getElementById('track-canvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate scale to fit track in canvas
            const padding = 20;
            const scaleX = (canvas.width - padding * 2) / (trackBounds.maxX - trackBounds.minX);
            const scaleY = (canvas.height - padding * 2) / (trackBounds.maxY - trackBounds.minY);
            const scale = Math.min(scaleX, scaleY);
            
            // Center the track (with vertical flip)
            const offsetX = (canvas.width - (trackBounds.maxX - trackBounds.minX) * scale) / 2 - trackBounds.minX * scale;
            const offsetY = (canvas.height - (trackBounds.maxY - trackBounds.minY) * scale) / 2 + trackBounds.maxY * scale;
            
            // Draw track outline
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 6;
            ctx.shadowColor = 'rgba(255, 215, 0, 0.5)';
            ctx.shadowBlur = 8;
            ctx.beginPath();
            
            trackWaypoints.forEach((point, index) => {
                const x = point.x * scale + offsetX;
                const y = -point.y * scale + offsetY; // Flip Y coordinate
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            // Close the track
            if (trackWaypoints.length > 0) {
                const firstPoint = trackWaypoints[0];
                const x = firstPoint.x * scale + offsetX;
                const y = -firstPoint.y * scale + offsetY; // Flip Y coordinate
                ctx.lineTo(x, y);
            }
            
            ctx.stroke();
            
            // Reset shadow for other elements
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            
            // Draw start/finish line
            if (trackWaypoints.length > 0) {
                const startPoint = trackWaypoints[0];
                const x = startPoint.x * scale + offsetX;
                const y = -startPoint.y * scale + offsetY; // Flip Y coordinate
                
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // Add flag symbol
                ctx.fillStyle = '#FFD700';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üèÅ', x, y - 8);
            }
        }
        
        function updateCarPosition(carX, carY) {
            if (!trackLoaded) return;
            
            // Calculate scale and offset (exactly same as drawTrack)
            const canvas = document.getElementById('track-canvas');
            const padding = 20;
            const scaleX = (canvas.width - padding * 2) / (trackBounds.maxX - trackBounds.minX);
            const scaleY = (canvas.height - padding * 2) / (trackBounds.maxY - trackBounds.minY);
            const scale = Math.min(scaleX, scaleY);
            
            // Use exact same offset calculation as in drawTrack
            const offsetX = (canvas.width - (trackBounds.maxX - trackBounds.minX) * scale) / 2 - trackBounds.minX * scale;
            const offsetY = (canvas.height - (trackBounds.maxY - trackBounds.minY) * scale) / 2 + trackBounds.maxY * scale;
            
            // Calculate video feed position (with vertical flip) - exact same as track drawing
            const canvasX = carX * scale + offsetX;
            const canvasY = -carY * scale + offsetY; // Flip Y coordinate
            
            // Move video feed to car position using absolute positioning
            const videoContainer = document.getElementById('video-container-moving');
            if (videoContainer) {
                videoContainer.style.left = canvasX + 'px';
                videoContainer.style.top = canvasY + 'px';
                videoContainer.style.transform = 'translate(-50%, -50%)';
            }
            
        }

        function triggerLapFinishAnimation() {
            // Animate the lap time display on the track map
            const trackLapTimeContainer = document.getElementById('track-lap-time');
            
            // Add flashing animation class
            if (trackLapTimeContainer) {
                trackLapTimeContainer.classList.add('lap-finish-animation');
            }
            
            // Clear any existing timeout
            if (lapFlashTimeout) {
                clearTimeout(lapFlashTimeout);
            }
            
            // Remove animation after 6 seconds (3 flashes √ó 2s each)
            lapFlashTimeout = setTimeout(() => {
                if (trackLapTimeContainer) {
                    trackLapTimeContainer.classList.remove('lap-finish-animation');
                }
            }, 6000);
        }
        
        function updateTelemetry(data) {
            console.log('updateTelemetry called with data:', data);
            
            // Race Telemetry
            const currentLapTime = data.lap_time || 0;
            const lapTimeText = currentLapTime.toFixed(1) + 's';
            console.log('Lap time:', lapTimeText);
            
            // Update lap time display on track map
            const trackLapTimeElement = document.getElementById('track-lap-time-value');
            if (trackLapTimeElement) {
                trackLapTimeElement.textContent = lapTimeText;
            }
            
            // Update speed displays
            const currentSpeed = data.actual_speed || 0;
            const speedText = currentSpeed.toFixed(2);
            
            // Update Ferrari speedometer
            const ferrariSpeedElement = document.getElementById('ferrari-speed-value');
            const speedNeedle = document.getElementById('speed-needle');
            const speedometerDial = document.getElementById('speedometer-dial');
            
            console.log('Speed:', speedText, 'Elements found:', {
                ferrari: !!ferrariSpeedElement,
                needle: !!speedNeedle,
                dial: !!speedometerDial
            });
            
            if (ferrariSpeedElement) {
                ferrariSpeedElement.textContent = speedText;
            }
            
            // Keep static Porsche design - no color changes needed
            
            // Animate the needle based on speed (0-2.8 m/s range for 180 degrees semi-circle)
            if (speedNeedle) {
                const maxSpeed = 2.8; // Maximum expected speed in m/s
                const speedRatio = Math.min(currentSpeed / maxSpeed, 1); // Clamp to 0-1
                const needleAngle = -90 + (speedRatio * 180); // -90 to +90 degrees (180¬∞ sweep for semi-circle)
                speedNeedle.style.transform = `translate(-50%, -50%) rotate(${needleAngle}deg)`;
            }
            
            // Note: lap-progress element was removed with race telemetry panel
            
            // Check for lap completion based on lap progress (completing all waypoints)
            const currentLapProgress = data.lap_progress || 0;
            
            // Initialize race tracking
            if (previousLapProgress === -1) {
                previousLapProgress = currentLapProgress;
                raceStarted = false;
                return; // Don't check for completion on first data point
            }
            
            // Mark race as started when we see meaningful progress (>10%)
            if (!raceStarted && currentLapProgress > 0.1) {
                raceStarted = true;
            }
            
            // Only check for lap completion after race has started and we've made significant progress
            if (raceStarted && previousLapProgress > 0.5) {
                // Detect lap completion: progress goes from high (near 1.0) back to low (near 0.0)
                // This indicates the car has completed all waypoints and started a new lap
                if (previousLapProgress > 0.85 && currentLapProgress < 0.15 && !lapCompleted) {
                    triggerLapFinishAnimation();
                    lapCompleted = true;
                    
                    // Reset flag after a short delay to allow for next lap detection
                    setTimeout(() => {
                        lapCompleted = false;
                    }, 5000);
                }
                
                // Also trigger if lap progress reaches 100% (in case progress doesn't reset)
                if (currentLapProgress >= 0.99 && previousLapProgress < 0.99 && !lapCompleted) {
                    triggerLapFinishAnimation();
                    lapCompleted = true;
                    
                    setTimeout(() => {
                        lapCompleted = false;
                    }, 5000);
                }
            }
            
            previousLapProgress = currentLapProgress;
            
            // Note: vision-system and speed-multiplier elements were removed with race telemetry panel
            
            // LIDAR Sensors
            const frontDist = data.wall_distances?.front;
            document.getElementById('front-distance').textContent = 
                frontDist === Infinity || frontDist > 100 ? '‚àû' : frontDist.toFixed(2) + 'm';
            
            const leftDist = data.wall_distances?.left;
            document.getElementById('left-distance').textContent = 
                leftDist === Infinity || leftDist > 100 ? '‚àû' : leftDist.toFixed(2) + 'm';
            
            const rightDist = data.wall_distances?.right;
            document.getElementById('right-distance').textContent = 
                rightDist === Infinity || rightDist > 100 ? '‚àû' : rightDist.toFixed(2) + 'm';
            
            // Update car position on track
            if (data.position && data.position.x !== undefined && data.position.y !== undefined) {
                console.log('Car position:', data.position.x, data.position.y);
                updateCarPosition(data.position.x, data.position.y);
            } else {
                console.log('No valid position data:', data.position);
            }

            // Update live commentary using efficient lookup
            if (data.commentary_section && data.commentary_idx >= 0) {
                const commentary = getCommentary(data.commentary_section, data.commentary_idx);
                document.getElementById('live-commentary').textContent = commentary;
            }
        }


        window.addEventListener('load', () => {
            connectToFirebase();
            loadTrackData();
        });
    </script>
</body>
</html>
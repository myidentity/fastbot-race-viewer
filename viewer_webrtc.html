<!DOCTYPE html>
<html>
<head>
    <title>Fastbot WebRTC Video Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .video-card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        #remoteVideo {
            width: 640px;
            height: 480px;
            background: #000;
            border: 2px solid #333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status-connecting {
            background: #fff3cd;
            color: #856404;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #log {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fastbot WebRTC Video Stream</h1>
        
        <div class="video-card">
            <h2>Live Camera Feed</h2>
            <video id="remoteVideo" autoplay playsinline></video>
            
            <div id="status" class="status status-disconnected">
                Disconnected
            </div>
            
            <div>
                <button id="connectBtn" onclick="connect()">Connect</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            </div>
            
            <div id="log"></div>
        </div>
    </div>

    <!-- Firebase v9 Modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, onDisconnect, remove } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAvTU18daJNd-LZXRdJB9cKoGqIpdElyk8",
            authDomain: "fastbot-racing.firebaseapp.com",
            databaseURL: "https://fastbot-racing-default-rtdb.firebaseio.com",
            projectId: "fastbot-racing",
            storageBucket: "fastbot-racing.appspot.com",
            messagingSenderId: "952502038002",
            appId: "1:952502038002:web:c1cf6a3a8eb9c2ae4c7d9f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let pc = null;
        let makingOffer = false;
        let polite = true; // Browser is always polite
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${timestamp}] ${message}<br>` + logDiv.innerHTML;
            console.log(message);
        }
        
        function updateStatus(status, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = 'status ' + className;
        }
        
        window.connect = async function() {
            log('Starting WebRTC connection...');
            updateStatus('Connecting...', 'status-connecting');
            
            // Create peer connection with minimal config
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            pc = new RTCPeerConnection(config);
            
            // Handle incoming stream
            pc.ontrack = (event) => {
                log('Received remote track');
                const video = document.getElementById('remoteVideo');
                if (video.srcObject !== event.streams[0]) {
                    video.srcObject = event.streams[0];
                    log('Video stream attached');
                }
            };
            
            // Connection state monitoring
            pc.onconnectionstatechange = () => {
                log(`Connection state: ${pc.connectionState}`);
                switch(pc.connectionState) {
                    case 'connected':
                        updateStatus('Connected', 'status-connected');
                        document.getElementById('connectBtn').disabled = true;
                        document.getElementById('disconnectBtn').disabled = false;
                        break;
                    case 'disconnected':
                    case 'failed':
                        updateStatus('Disconnected', 'status-disconnected');
                        document.getElementById('connectBtn').disabled = false;
                        document.getElementById('disconnectBtn').disabled = true;
                        break;
                }
            };
            
            pc.oniceconnectionstatechange = () => {
                log(`ICE connection state: ${pc.iceConnectionState}`);
            };
            
            pc.onicegatheringstatechange = () => {
                log(`ICE gathering state: ${pc.iceGatheringState}`);
            };
            
            // Set up signaling via Firebase
            const signalingRef = ref(database, 'robots/race_monitor/webrtc_signaling');
            
            // Listen for offers from robot
            onValue(ref(database, 'robots/race_monitor/webrtc_signaling/offer'), async (snapshot) => {
                const offer = snapshot.val();
                if (offer && pc) {
                    log('Received offer from robot');
                    try {
                        await pc.setRemoteDescription(offer);
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        await set(ref(database, 'robots/race_monitor/webrtc_signaling/answer'), {
                            type: answer.type,
                            sdp: answer.sdp
                        });
                        log('Sent answer to robot');
                    } catch (err) {
                        log(`Error handling offer: ${err.message}`);
                    }
                }
            });
            
            // Listen for ICE candidates from robot
            onValue(ref(database, 'robots/race_monitor/webrtc_signaling/robot_candidates'), async (snapshot) => {
                const candidates = snapshot.val();
                if (candidates && pc) {
                    for (const key in candidates) {
                        try {
                            await pc.addIceCandidate(candidates[key]);
                            log(`Added ICE candidate from robot`);
                        } catch (err) {
                            log(`Error adding ICE candidate: ${err.message}`);
                        }
                    }
                }
            });
            
            // Send our ICE candidates to robot
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    const candidateRef = ref(database, `robots/race_monitor/webrtc_signaling/browser_candidates/${Date.now()}`);
                    await set(candidateRef, event.candidate.toJSON());
                    log('Sent ICE candidate to robot');
                }
            };
            
            // Signal that browser is ready
            await set(ref(database, 'robots/race_monitor/webrtc_signaling/browser_ready'), true);
            log('Browser ready signal sent');
        };
        
        window.disconnect = async function() {
            log('Disconnecting...');
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            // Clear signaling
            await remove(ref(database, 'robots/race_monitor/webrtc_signaling'));
            
            const video = document.getElementById('remoteVideo');
            video.srcObject = null;
            
            updateStatus('Disconnected', 'status-disconnected');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            log('Disconnected');
        };
        
        // Auto-connect on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Auto-connecting...');
                connect();
            }, 1000);
        });
    </script>
</body>
</html>
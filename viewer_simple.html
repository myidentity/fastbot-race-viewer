<!DOCTYPE html>
<html>
<head>
    <title>Fastbot Monitor (Simple Mode)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .telemetry-card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #4CAF50;
        }
        .status-disconnected {
            background-color: #f44336;
        }
        .race-commentary {
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèéÔ∏è Fastbot Monitor - Simple Mode</h1>
        <p>Real-time telemetry via Firebase (no WebRTC required)</p>
        
        <div class="telemetry-card">
            <h2>Connection Status</h2>
            <div>
                <span id="firebase-status" class="status-indicator status-disconnected"></span>
                Firebase: <span id="firebase-text">Connecting...</span>
            </div>
        </div>

        <div class="telemetry-card">
            <h2>Race Telemetry</h2>
            <div class="metric">
                <div class="metric-label">Lap Count</div>
                <div class="metric-value" id="lap-count">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Lap Time</div>
                <div class="metric-value" id="lap-time">0.0s</div>
            </div>
            <div class="metric">
                <div class="metric-label">Actual Speed</div>
                <div class="metric-value" id="speed">0.0 m/s</div>
            </div>
            <div class="metric">
                <div class="metric-label">Position</div>
                <div class="metric-value" id="position">(0.0, 0.0)</div>
            </div>
            <div class="metric">
                <div class="metric-label">Waypoint</div>
                <div class="metric-value" id="waypoint">0 / 0</div>
            </div>
        </div>

        <div class="telemetry-card">
            <h2>Live Video Feed (~5Hz)</h2>
            <div style="text-align: center;">
                <img id="video-feed" style="width: 320px; height: 320px; border: 1px solid #ccc; background: #000; image-rendering: pixelated;">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    <span id="video-fps">0</span> FPS | <span id="video-delay">0</span>ms delay
                </div>
            </div>
        </div>

        <div class="telemetry-card">
            <h2>Race Commentary</h2>
            <div class="race-commentary" id="commentary">
                Waiting for race data...
            </div>
        </div>

        <div class="telemetry-card">
            <h2>Latest Telemetry Update</h2>
            <pre id="raw-data" style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">
Waiting for connection...
            </pre>
        </div>
    </div>

    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        // Firebase configuration (saved from previous session)
        const firebaseConfig = {
            apiKey: "AIzaSyDRaKw_Yj8J_tvMR75Ejlkz5ASpyLQJotg",
            authDomain: "summer-race-monitoring.firebaseapp.com",
            databaseURL: "https://summer-race-monitoring-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "summer-race-monitoring"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Update UI status
        document.getElementById('firebase-status').className = 'status-indicator status-connected';
        document.getElementById('firebase-text').textContent = 'Connected';

        // Listen for telemetry updates
        const telemetryRef = ref(database, 'robots/race_monitor/telemetry');
        onValue(telemetryRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                updateTelemetry(data);
            }
        });

        // Listen for video frames
        const videoRef = ref(database, 'robots/race_monitor/video_frame');
        let frameCount = 0;
        let lastFrameTime = Date.now();
        let fpsTimer = setInterval(() => {
            const fps = frameCount;
            frameCount = 0;
            document.getElementById('video-fps').textContent = fps;
        }, 1000);

        onValue(videoRef, (snapshot) => {
            const frameData = snapshot.val();
            if (frameData && frameData.image) {
                // Update video feed
                const img = document.getElementById('video-feed');
                img.src = 'data:image/jpeg;base64,' + frameData.image;
                
                // Calculate delay
                const now = Date.now();
                const frameTime = frameData.timestamp * 1000; // Convert to ms
                const delay = now - frameTime;
                document.getElementById('video-delay').textContent = Math.round(delay);
                
                // Count frames for FPS
                frameCount++;
                lastFrameTime = now;
            }
        });

        function updateTelemetry(data) {
            // Update telemetry displays
            document.getElementById('lap-count').textContent = data.lap_count || 0;
            document.getElementById('lap-time').textContent = (data.lap_time || 0).toFixed(1) + 's';
            document.getElementById('speed').textContent = (data.actual_speed || 0).toFixed(2) + ' m/s';
            document.getElementById('position').textContent = 
                `(${(data.position?.x || 0).toFixed(1)}, ${(data.position?.y || 0).toFixed(1)})`;
            document.getElementById('waypoint').textContent = 
                `${data.current_waypoint || 0} / ${data.total_waypoints || 0}`;

            // Update commentary
            if (data.race_commentary) {
                document.getElementById('commentary').textContent = data.race_commentary;
            }

            // Update raw data (last 5 fields for brevity)
            const summary = {
                lap_count: data.lap_count,
                lap_time: data.lap_time,
                actual_speed: data.actual_speed,
                position: data.position,
                current_waypoint: data.current_waypoint,
                timestamp: new Date(data.timestamp * 1000).toLocaleTimeString()
            };
            document.getElementById('raw-data').textContent = JSON.stringify(summary, null, 2);
        }

        console.log('Simple viewer connected to Firebase - no WebRTC required!');
    </script>
</body>
</html>